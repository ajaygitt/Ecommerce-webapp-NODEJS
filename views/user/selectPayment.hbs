<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script
  src="https://www.paypal.com/sdk/js?client-id=AXCYt_xCh1RQeq3VBd79TVwRrn58jdYVaC2czZ3m_wRE5UhWdFx5agm7I_GS2x0ysPzryfeA9JQTCqu6&disable-funding=credit,card"></script>






<div class="container">
  <div class="py-5 text-center">

    <h2>Checkout form</h2>
    <p class="lead">Fill the form and continue to Checkout</p>
  </div>

  <div class="row">
    <div class="col-md-4 order-md-2 mb-4">
      <h4 class="d-flex justify-content-between align-items-center mb-3">
        <span class="text-muted">Your cart</span>
        <span class="badge badge-secondary badge-pill">3</span>
      </h4>
      <ul class="list-group mb-3">
    
        <li class="list-group-item d-flex justify-content-between lh-condensed">
          <div>
            <h6 class="my-0">Discount from Referal Credits</h6>
            <small class="text-muted">Discount from referal credits</small>
          </div>
        {{#if credits}}  <span class="text-muted">₹{{credits}}</span>{{else}}<span class="text-muted">₹0</span>{{/if}}
        </li>
        <li class="list-group-item d-flex justify-content-between lh-condensed">
          <div>
            <h6 class="my-0">Discount in (%)</h6>
            <small class="text-muted">discount applied in percentage</small>
          </div>
          <span class="text-muted" id="discountprice">{{d}}</span>
        </li>
         <li class="list-group-item d-flex justify-content-between lh-condensed">
          <div>
            <h6 class="my-0">Actual price</h6>
            <small class="text-muted">price without discount</small>
          </div>
          <span class="text-muted">₹
{{total}}</span>
        </li>


        <li class="list-group-item d-flex justify-content-between bg-light">
          <div class="text-success">
            <h6 class="my-0">Voucher Code discount </h6>
            <small>voucher-discount</small>
          </div>
          <span class="text-success" id="voucher-discount" > </span>
        </li>
         
        <li class="list-group-item d-flex justify-content-between">
          <span>Total (Rupees)</span>
          <strong id="grandTotal"
          >{{total}}</strong>
        </li>
      </ul>

     
        <div class="input-group">
         <input type="text" value="{{userfound._id}}" style="display:none;" id="input-user">
          <input type="text" class="form-control" id="input-coupon" name="coupon" placeholder="Promo code">
          <div class="input-group-append">
            <button type="coupon" id="coupon-code" onclick="applyCoupon()" class="btn btn-secondary">Reedem code</button>
       
          </div>
 	<p id="success" style="display: none; color: red;"><strong>*suucess coupon applied</strong></p>
    	<p id="used" style="display: none; color: red;"><strong>*coupon is alreadey used cannot apply</strong></p>
       	<p id="invalid" style="display: none; color: red;"><strong>*invalid coupon try the correct couopon code</strong></p>
        </div>
      




{{!-- 
{{#each address}}

<div class="centers" >
address  <input type="text"  id="newaddress" value="{{this.address}}"><br>
Zip<input type="text" id="newzip" value="{{this.zip}}"><br>
email <input type="text" id="newemail" value="{{this.email}}"><br>
phone number <input type="text"id="newphone" value="{{this.phone_number}}"><br>
 
      <button class="btn btn-primary" onclick="usethis('{{this._id}}')">Use This Address</button>
</div>
{{/each}}

      --}}
    </div>
    <div class="col-md-8 order-md-1">
      <h4 class="mb-3">Billing address</h4>


      <form class="needs-validation" id="checkout-form" novalidate>
        <div class="row">
        
          <div class="col-md-6 mb-3">
            <label for="firstName">First name</label>
            <input type="text" class="form-control" name="first_name" id="firstName" placeholder="" value="{{userfound.first_name}}" required>
            <div class="invalid-feedback">
              Valid first name is required.
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <label for="lastName">Last name</label>
            <input type="text" class="form-control" name="last_name" id="lastName" placeholder="" value="" required>
            <div class="invalid-feedback">
              Valid last name is required.
            </div>
          </div>
        </div>



{{!-- sends data --}}
        <input type="hidden"  name="offerId" id="offerId">




        <div class="mb-3">
          <label for="username">Phone Number</label>
          <div class="input-group">
            <div class="input-group-prepend" ]>

            </div>
            <input type="text" class="form-control" id="phone_number" name="phone_number" placeholder="Username"
              required>
            <div class="invalid-feedback" style="width: 100%;">
              Your username is required.
            </div>
          </div>
        </div>

        <div class="mb-3">
          <input type="text" name="userId" id="userId" value="{{userfound._id}}" hidden>
          <label for="email">Email <span class="text-muted">(Optional)</span></label>
          <input type="email" class="form-control" id="email" name="email" >
          <div class="invalid-feedback">
            Please enter a valid email address for shipping updates.
          </div>
        </div>

        <div class="mb-3">
          <label for="address">Address</label>
          <input type="text" class="form-control" id="address" name="address" placeholder="1234 Main St" required>
          <div class="invalid-feedback">
            Please enter your shipping address.
          </div>
        </div>

        <div class="row">
          <div class="col-md-5 mb-3">
            <label for="country">Country</label>
            <select class="custom-select d-block w-100" id="country" required>
              <option value="">Choose...</option>
              <option value="india">India</option>
            </select>
            <div class="invalid-feedback">
              Please select a valid country.
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <label for="state">State</label>
            <select class="custom-select d-block w-100" id="state" name="state" required>
              <option value="">Choose...</option>
              <option value="kerala" >Kerala</option>
            </select>
            <div class="invalid-feedback">
              Please provide a valid state.
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <label for="zip">Zip</label>
            <input type="text" name="zip" class="form-control" id="zip" placeholder="" required>
            <div class="invalid-feedback">
              Zip code required.
            </div>
          </div>
        </div>
        <hr class="mb-4">

        <hr class="mb-4">

        <h4 class="mb-3">Payment</h4>

        <div class="d-block my-3">
          <div class="custom-control custom-radio">
            <input id="credit" name="paymentMethod" type="radio" value="cod" class="custom-control-input" checked
              required>
            <label class="custom-control-label" for="credit"> ---Cash On Delivery</label>
          </div>
          <div class="custom-control custom-radio">
            <input id="debit" name="paymentMethod" value="Razor_Pay" type="radio" class="custom-control-input" required>
            <label class="custom-control-label" for="debit">---Razor Pay</label>
          </div>
          <div class="custom-control custom-radio">
            <input id="paypal" name="paymentMethod" type="radio" value="paypal" class="custom-control-input" required>
            <label class="custom-control-label" for="paypal">---PayPal</label>
          </div>
        </div>
        <div class="row">


        </div>
        <div class="row">

<div id="paypal-payment-button"></div>
        </div>
        <hr class="mb-4">
        <button class="btn btn-primary btn-lg btn-block" type="submit">Continue to checkout</button>
        
      </form>


    </div>
  </div>
{{!-- 
  <footer class="my-5 pt-5 text-muted text-center text-small">
    <p class="mb-1">&copy; 2017-2019 Company Name</p>
    <ul class="list-inline">
      <li class="list-inline-item"><a href="#">Privacy</a></li>
      <li class="list-inline-item"><a href="#">Terms</a></li>
      <li class="list-inline-item"><a href="#">Support</a></li>
    </ul>
  </footer> --}}
  <div></div>
<div class="row">
{{#each address}}
  <div class="col-sm-6">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Special title treatment</h5>
           <p class="card-text">address<input type="text" id="newaddress" value="{{this.address}}"></p>
              <p class="card-text">email id<input type="text" id="newemail" value="{{this.email}}"></p>
                 <p class="card-text">mobile:<input type="text" id="newphone" value="{{this.phone_number}}"></p>
        <p class="card-text">Zip pin:<input type="text" id="newzip" value="{{this.zip}}"></p>

        <a  class="btn btn-primary" onclick="usethis('{{this._id}}')">Use this Address</a>
      </div>
    </div>
  </div>
  {{/each}}
  {{!-- <div class="col-sm-6">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Special title treatment</h5>
        <p class="card-text">With supporting text below as a natural lead-in to additional content.</p>
        <a href="#" class="btn btn-primary">Use this address</a>
      </div>
    </div>
  </div> --}}
</div>
<a href="/add-address"> <button class="btn btn-success"  >add new address</button></a>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>

function applyCoupon(){
console.log('ividund')
  let coupon=$('#input-coupon').val()
  let user=$('#input-user').val()
console.log("couponhere",coupon)
  $.ajax({
url:'/verifyCoupon',
method:'POST',
data:{
  coupon,
  user
},
   success:(response)=>{

if(response.status==0){

  $('#success').show()
  $('#used').hide()
 $('#invalid').hide()
let totalAmount=document.getElementById('grandTotal').innerHTML
let discountPrice=totalAmount*(100-response.offer)/100


document.getElementById('grandTotal').innerHTML=discountPrice
document.getElementById('voucher-discount').innerHTML=discountPrice
document.getElementById('discountprice').innerHTML=response.offer

$('#offerId').val(response.offer)
console.log('@@@@@@@@@@',discountPrice)


}
else if(response.status==2){
  $('#used').show()
  $('#success').hide()
  $('#invalid').hide()
}
else if(response.status==1){
  $('#invalid').show()
  $('#used').hide()
  $('#success').hide()
}
   }

  })
}



  $("#checkout-form").submit((e) => {
    e.preventDefault()
    $.ajax({
      url: '/place-order',
      method: 'post',
      data: $('#checkout-form').serialize(),
      success: (response) => {
        
        if (response.cod_success) {
          location.href = '/order-placed'

        }
        else if (response.paypal) {
          console.log('hi')
          paypal.Buttons({
            createOrder: function (data, actions) {
              return actions.order.create({
                purchase_units: [{
                  amount: {
                    value: response.total
                  }
                }]
              })
            },
            onApprove: function (data, action) {
              return action.order.capture().then(function (details) {
               location.href = '/order-placed'
              })
            }
          }).render('#paypal-payment-button');

        }


        else {
          razorpayPayment(response)
        }
      }
    })
  })






  function razorpayPayment(order) {

    var options = {
      "key": "rzp_test_Qr0tA6O1xhCdHy", // Enter the Key ID generated from the Dashboard
      "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
      "currency": "INR",
      "name": "E-CART",
      "description": "Test Transaction",
      "image": "https://example.com/your_logo",
      "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
      "handler": function (response) {


        verifyPayment(response, order)

      },
      "prefill": {
        "name": "ajay pradeep",
        "email": "ajay1712@example.com",
        "contact": "8156803272"
      },
      "notes": {
        "address": "Razorpay Corporate Office"
      },
      "theme": {
        "color": "#3399cc"
      }
    };
    var rzp1 = new Razorpay(options);
    rzp1.open();

  }
  function verifyPayment(payment, order) {
    $.ajax({
      url: '/verify-payment',
      data: {
        payment,
        order
      },
      method: 'POST',
      success: (response) => {
        if(response.status)
        {
        location.href = '/order-placed'
        }
        else{
          alert("failed payment")
        }
      }
    })
  }


  function usethis(addId){
  
var x = document.getElementById("newaddress").value;
var y=document.getElementById("newzip").value;
console.log("etthi")
var z=document.getElementById("newemail").value;
var a=document.getElementById("newphone").value;


document.getElementById("address").value = x;
document.getElementById("zip").value=y;
document.getElementById("email").value=z;
document.getElementById("phone_number").value=a;
  }

</script>



<style>
  .centers{
     width: 50px;
  height: 50px;

  position: absolute;
  top: 65%;
  left: 50%;
  margin: -25px 0 0 -25px; 
  },
  .centers2{
     width: 50px;
  height: 50px;

  position: absolute;
  top: 95%;
  left: 50%;
  margin: -25px 0 0 -25px; 
  },


  
</style>